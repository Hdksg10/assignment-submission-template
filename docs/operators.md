# ç®—å­è§„æ ¼è¯´æ˜ï¼ˆSpark MLlib vs Ray Dataï¼‰

> **ç›®çš„**ï¼šç”¨ç»Ÿä¸€çš„è§„æ ¼ä¸æµ‹è¯•æ¡†æ¶ï¼Œå¯¹æ¯” Spark MLlib ä¸ Ray Data åœ¨å¸¸è§é¢„å¤„ç†ç®—å­ä¸Šçš„**è¯­ä¹‰ä¸€è‡´æ€§**ä¸**æ€§èƒ½è¡¨ç°**ã€‚  
> **æ ¸å¿ƒç»“è®ºï¼ˆå¯¹åŸè®¾è®¡çš„ä¿®æ”¹ç‚¹ï¼‰**ï¼š
> 1) Ray ä¾§ä¸åº”é»˜è®¤â€œ`map_batches + sklearn` ç­‰ä»· Sparkâ€ã€‚**æœ‰çŠ¶æ€ç®—å­å¿…é¡»æ‹†æˆ `fit â†’ transform`**ï¼Œå¦åˆ™ä¼šå‡ºç°â€œæ¯ä¸ª batch å„è‡ª fitâ€çš„é”™è¯¯è¯­ä¹‰ã€‚  
> 2) Ray ä¾§ä¼˜å…ˆä½¿ç”¨ Ray Data çš„ **preprocessorsï¼ˆè‹¥å¯ç”¨ï¼‰**ï¼Œå…¶æ¬¡æ˜¯è‡ªç ”çš„å…¨å±€èšåˆ `fit/transform`ï¼Œæœ€åæ‰æ˜¯ stateless çš„ `map_batches`ã€‚  
> 3) å¯¹é½éš¾ç‚¹ä¸»è¦æ¥è‡ª**å‚æ•°/è¯­ä¹‰ä¸ä¸€è‡´**ï¼ˆå¦‚ StandardScaler çš„ `with_mean/with_std`ã€MinMax çš„ `min/max`ã€Imputer çš„ `median`ã€StringIndexer çš„ `handleInvalid`ã€OneHot çš„ `drop_last`ã€IDF çš„å…¨å±€ DFï¼‰ã€‚è¿™äº›å¿…é¡»åœ¨è§„æ ¼ä¸­æ˜¾å¼å†™å‡ºâ€œå¯¹é½ç­–ç•¥â€ã€‚  
> 4) æ–‡æœ¬ç®—å­é‡Œ **HashingTF å¯ stateless**ï¼Œä½† **IDF å¿…é¡» stateful**ï¼ˆéœ€è¦å…¨å±€ DF/IDF çš„ fitï¼‰ã€‚  
> 5) å·¥ç¨‹å±‚éœ€è¦å†™æ­»çº¦æŸï¼šç»Ÿä¸€ `batch_format`ã€ç¦æ­¢å°±åœ°ä¿®æ”¹ batchã€ç»Ÿä¸€è¾“å‡ºæ ¼å¼ï¼ˆç¨€ç–/ç¨ å¯†ï¼‰ã€ç»Ÿä¸€è¯¯å·®å®¹å¿ä¸éšæœºæ€§æ§åˆ¶ã€‚

---

## 1. è®¾è®¡åŸåˆ™ï¼ˆå¿…é¡»éµå¾ªï¼‰

### 1.1 è¯­ä¹‰ä¼˜å…ˆï¼šStateful vs Stateless

- **Statefulï¼ˆæœ‰çŠ¶æ€ï¼‰**ï¼šéœ€è¦å…¨å±€ç»Ÿè®¡/è¯è¡¨/æ˜ å°„ï¼Œå¿…é¡»æ”¯æŒï¼š
  - `fit(dataset) -> state`
  - `transform(dataset, state) -> dataset`
  - å…¸å‹ï¼šStandardScalerã€MinMaxScalerã€Imputerã€StringIndexerã€OneHotEncoderï¼ˆé€šå¸¸éœ€è¦ç±»åˆ«é›†åˆï¼‰ã€IDF
- **Statelessï¼ˆæ— çŠ¶æ€ï¼‰**ï¼šä¸éœ€è¦å…¨å±€ç»Ÿè®¡ï¼Œé€è¡Œ/é€æ‰¹å³å¯å®Œæˆï¼š
  - å…¸å‹ï¼šTokenizerã€HashingTFï¼ˆå“ˆå¸Œå‘é‡åŒ–æœ¬èº«æ— é¡»è¯è¡¨ï¼‰

> **ç¡¬è§„åˆ™**ï¼šStateful ç®—å­ **ç¦æ­¢** åœ¨ `map_batches` å†… `fit`ã€‚å¿…é¡»å…ˆå…¨å±€ `fit` å† `transform`ã€‚

---

### 1.2 Ray å®ç°è·¯å¾„ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰

Ray ä¾§æ¯ä¸ªç®—å­æŒ‰å¦‚ä¸‹é¡ºåºé€‰æ‹©å®ç°æ–¹å¼ï¼š

1. **ä¼˜å…ˆï¼šRay Data preprocessors**ï¼ˆè‹¥èƒ½æ»¡è¶³å¯¹é½è¯­ä¹‰/å‚æ•°è¦æ±‚ï¼‰  
2. **å…¶æ¬¡ï¼šè‡ªç ” `fit/transform`**ï¼ˆå…¨å±€èšåˆç»Ÿè®¡ + åˆ†å¸ƒå¼ transformï¼‰ï¼Œç”¨äºè¡¥é½ Spark å‚æ•°/è¯­ä¹‰  
3. **æœ€åï¼š`map_batches + sklearn/è‡ªå®šä¹‰å‡½æ•°`**ï¼ˆä»…é™ Stateless æˆ–æ˜ç¡®å·²å…¨å±€ fit çš„æƒ…å†µï¼‰

---

### 1.3 å‚æ•°å¯¹é½ç­–ç•¥ï¼ˆä¸‰é€‰ä¸€ï¼Œå¿…é¡»æ˜¾å¼æ ‡æ³¨ï¼‰

æ¯ä¸ªç®—å­å¿…é¡»é€‰æ‹©å¹¶å†™æ˜ä¸€ç§ç­–ç•¥ï¼š

- **A. æ”¶æ•›åˆ°äº¤é›†ï¼ˆIntersectionï¼‰**ï¼šåªæ”¯æŒä¸¤å¼•æ“éƒ½èƒ½ä¸¥æ ¼å¯¹é½çš„å‚æ•°å­é›†  
- **B. Ray è¡¥å®ç°ï¼ˆRay-Extendedï¼‰**ï¼šRay ä¾§è‡ªç ” `fit/transform`ï¼Œè¡¥é½ Spark è¯­ä¹‰ä¸å‚æ•°  
- **C. æ ‡æ³¨ä¸æ”¯æŒï¼ˆEngine-Specificï¼‰**ï¼šæ˜ç¡® â€œSpark-only / Ray-onlyâ€ï¼Œå¹¶åœ¨æµ‹è¯•ä¸­è·³è¿‡æˆ–å•ç‹¬è¯„ä¼°

---

### 1.4 è¾“å‡ºæ ¼å¼ä¸å¯æ¯”æ€§çº¦æŸ

ä¸ºä¾¿äºä¸€è‡´æ€§æ ¡éªŒä¸æ€§èƒ½å¯¹æ¯”ï¼š

- æ•°å€¼åˆ—ï¼šç»Ÿä¸€ `float64`ï¼ˆé»˜è®¤ï¼‰ï¼Œé¿å… float32 å¼•å…¥é¢å¤–è¯¯å·®å·®å¼‚  
- ç±»åˆ«ç´¢å¼•åˆ—ï¼šç»Ÿä¸€ `int64`ï¼ˆé»˜è®¤ï¼‰ï¼›è‹¥ Ray ä¾§ä¼šäº§ç”Ÿ `NaN`ï¼Œéœ€åœ¨å¯¹é½ç­–ç•¥ä¸­å®šä¹‰æ›¿ä»£ï¼ˆå¦‚ unknown bucketï¼‰  
- OneHot/æ–‡æœ¬å‘é‡ï¼š
  - **åŸºå‡†ç‰ˆï¼ˆé»˜è®¤ï¼‰**ï¼šè¾“å‡ºä¸ºâ€œå›ºå®šé•¿åº¦ç¨ å¯†å‘é‡â€ï¼ˆ`list[float]` æˆ– `np.ndarray`ï¼‰ï¼Œä¾¿äºè·¨å¼•æ“æ¯”è¾ƒ  
  - **æ€§èƒ½ç‰ˆï¼ˆå¯é€‰ï¼‰**ï¼šå…è®¸ç¨€ç–è¡¨ç¤ºï¼Œä½†éœ€å•ç‹¬å®šä¹‰ä¸€è‡´æ€§æ¯”è¾ƒæ–¹æ³•ä¸åºåˆ—åŒ–æ ¼å¼

---

### 1.5 è¯¯å·®å®¹å¿ä¸ä¸€è‡´æ€§åˆ¤å®š

- æ•°å€¼ä¸€è‡´æ€§ï¼šé»˜è®¤ `atol=1e-6, rtol=1e-6`ï¼ˆå¯æŒ‰ç®—å­è°ƒæ•´ï¼‰  
- ç±»åˆ«ä¸€è‡´æ€§ï¼šè¦æ±‚å®Œå…¨ä¸€è‡´ï¼ˆæˆ–æŒ‰å¯¹é½ç­–ç•¥å®šä¹‰çš„ç­‰ä»·ç±»ä¸€è‡´ï¼‰  
- æ–‡æœ¬å‘é‡ä¸€è‡´æ€§ï¼šè¦æ±‚ç»´åº¦ä¸€è‡´ã€éé›¶ä½ç½®ä¸€è‡´ï¼ˆå“ˆå¸Œå†²çªå¯¼è‡´çš„å·®å¼‚éœ€è®°å½•ï¼‰

---

### 1.6 Ray å·¥ç¨‹çº¦æŸï¼ˆå¿…é¡»å†™è¿›å®ç°è§„èŒƒï¼‰

- å›ºå®š `batch_format`ï¼ˆå»ºè®®å…¨é¡¹ç›®ç»Ÿä¸€ä¸º `pandas` æˆ– `numpy`ï¼Œé»˜è®¤æ¨è `pandas` ä»¥å…¼å®¹ sklearnï¼›è‹¥è¿½æ±‚æ•°å€¼æ€§èƒ½å¯ç”¨ `numpy`ï¼‰  
- **ç¦æ­¢å°±åœ°ä¿®æ”¹è¾“å…¥ batch**ï¼šUDF å†…å¿…é¡»å†™å…¥æ–°åˆ—æˆ–æ‹·è´åä¿®æ”¹  
- éšæœºæ€§æ§åˆ¶ï¼šå¦‚æ¶‰åŠé‡‡æ ·/æˆªæ–­/å“ˆå¸Œç§å­ï¼Œå¿…é¡»æ”¯æŒ `seed`ï¼ˆæˆ–å£°æ˜æ— éšæœºï¼‰

---

## 2. ç®—å­åˆ†ç±»

### 2.1 æ•°å€¼é¢„å¤„ç†ï¼ˆNumerical Preprocessingï¼‰
- StandardScaler
- MinMaxScaler
- Imputer

### 2.2 ç±»åˆ«é¢„å¤„ç†ï¼ˆCategorical Preprocessingï¼‰
- StringIndexer
- OneHotEncoder

### 2.3 æ–‡æœ¬é¢„å¤„ç†ï¼ˆText Preprocessingï¼‰
- Tokenizer
- HashingTF
- IDFï¼ˆInverse Document Frequencyï¼‰

---

## 3. ç®—å­è§„æ ¼ï¼ˆå«å¯¹é½ç­–ç•¥ä¸ Ray è®¾è®¡ï¼‰

> ç»Ÿä¸€å­—æ®µæ¨¡æ¿ï¼š  
> - **ç±»å‹**ï¼šStateful / Stateless  
> - **å¯¹é½ç­–ç•¥**ï¼šIntersection / Ray-Extended / Engine-Specific  
> - **Ray æ¨èå®ç°**ï¼špreprocessor / è‡ªç ” fit-transform / map_batches  
> - **å·®å¼‚ç‚¹**ï¼šå¿…é¡»å†™æ¸…ï¼ˆå°¤å…¶æ˜¯ unknown/invalidã€drop_lastã€ç»´åº¦ã€dtype ç­‰ï¼‰

---

### 3.1 StandardScaler

- **åŠŸèƒ½**ï¼šæ ‡å‡†åŒ–æ•°å€¼ç‰¹å¾ï¼ˆz-scoreï¼š`(x - mean) / std`ï¼‰
- **ç±»å‹**ï¼šStatefulï¼ˆéœ€è¦å…¨å±€ mean/stdï¼‰
- **è¾“å…¥**ï¼šæ•°å€¼åˆ—
- **è¾“å‡º**ï¼šæ ‡å‡†åŒ–åçš„æ•°å€¼åˆ—
- **å‚æ•°**ï¼š
  - `with_mean`ï¼šæ˜¯å¦ä¸­å¿ƒåŒ–ï¼ˆé»˜è®¤ Trueï¼‰
  - `with_std`ï¼šæ˜¯å¦æ ‡å‡†åŒ–ï¼ˆé»˜è®¤ Trueï¼‰
- **Spark å®ç°**ï¼š`StandardScaler`
- **Ray æ¨èå®ç°**ï¼š
  - ä¼˜å…ˆï¼šRay preprocessorï¼ˆè‹¥å…¶æ”¯æŒæ‰€éœ€è¯­ä¹‰ï¼‰
  - è‹¥éœ€ä¸¥æ ¼æ”¯æŒ `with_mean/with_std`ï¼š**è‡ªç ” fit/transform**
    - `fit`ï¼šå…¨å±€èšåˆæ¯åˆ— mean/stdï¼ˆæŒ‰ `with_*` å¼€å…³è®¡ç®—ï¼‰
    - `transform`ï¼š`map_batches` åº”ç”¨å˜æ¢
- **å¯¹é½ç­–ç•¥**ï¼ˆå¿…é¡»äºŒé€‰ä¸€ï¼‰ï¼š
  - **Intersection**ï¼šå›ºå®š `with_mean=True, with_std=True`ï¼ˆRay ä¸æš´éœ²å¼€å…³æ—¶ï¼‰
  - **Ray-Extended**ï¼šRay è‡ªç ”ä»¥æ”¯æŒå¼€å…³
- **å·®å¼‚ç‚¹**ï¼š
  - è‹¥ `with_std=False`ï¼Œéœ€å®šä¹‰è¾“å‡ºä¸ºä»…ä¸­å¿ƒåŒ–æˆ–åŸå€¼ï¼ˆä¸ Spark å¯¹é½ï¼‰
  - å¤„ç†å¸¸æ•°åˆ—ï¼ˆstd=0ï¼‰ç­–ç•¥éœ€ä¸€è‡´ï¼ˆå¦‚è¾“å‡º 0 æˆ–ä¿æŒåŸå€¼ï¼Œéœ€æ˜ç¡®ï¼‰

---

### 3.2 MinMaxScaler

- **åŠŸèƒ½**ï¼šæœ€å°æœ€å¤§æ ‡å‡†åŒ–åˆ° `[min, max]`
- **ç±»å‹**ï¼šStatefulï¼ˆéœ€è¦å…¨å±€ min/maxï¼‰
- **è¾“å…¥**ï¼šæ•°å€¼åˆ—
- **è¾“å‡º**ï¼šç¼©æ”¾åçš„æ•°å€¼åˆ—
- **å‚æ•°**ï¼š
  - `min`ï¼šç›®æ ‡æœ€å°å€¼ï¼ˆé»˜è®¤ 0.0ï¼‰
  - `max`ï¼šç›®æ ‡æœ€å¤§å€¼ï¼ˆé»˜è®¤ 1.0ï¼‰
- **Spark å®ç°**ï¼š`MinMaxScaler`
- **Ray æ¨èå®ç°**ï¼š
  - è‹¥ Ray preprocessor ä»…æ”¯æŒ `[0,1]`ï¼šå¯ç”¨ preprocessor + æ–‡æ¡£æ”¶æ•›ç­–ç•¥
  - è‹¥éœ€æ”¯æŒä»»æ„ `[min,max]`ï¼š**è‡ªç ” fit/transform**
    - `fit`ï¼šå…¨å±€èšåˆæ¯åˆ— min/max
    - `transform`ï¼šçº¿æ€§å˜æ¢åˆ°ç›®æ ‡èŒƒå›´
- **å¯¹é½ç­–ç•¥**ï¼š
  - **Intersection**ï¼šå›ºå®š `[0,1]`
  - **Ray-Extended**ï¼šRay è‡ªç ”æ”¯æŒä»»æ„ `[min,max]`
- **å·®å¼‚ç‚¹**ï¼š
  - å¸¸æ•°åˆ—ï¼ˆmax==minï¼‰è¾“å‡ºè§„åˆ™å¿…é¡»ä¸€è‡´

---

### 3.3 Imputer

- **åŠŸèƒ½**ï¼šç¼ºå¤±å€¼å¡«å……
- **ç±»å‹**ï¼šStatefulï¼ˆé™¤ constant å¤–é€šå¸¸éœ€è¦å…¨å±€ç»Ÿè®¡ï¼‰
- **è¾“å…¥**ï¼šåŒ…å«ç¼ºå¤±å€¼çš„æ•°å€¼åˆ—
- **è¾“å‡º**ï¼šå¡«å……åçš„æ•°å€¼åˆ—
- **å‚æ•°**ï¼š
  - `strategy`ï¼š`'mean' | 'median' | 'most_frequent' | 'constant'`
  - `fill_value`ï¼šå½“ `strategy='constant'` æ—¶ä½¿ç”¨
- **Spark å®ç°**ï¼š`Imputer`
- **Ray æ¨èå®ç°**ï¼š
  - ä¼˜å…ˆï¼šRay preprocessorï¼ˆè‹¥æ”¯æŒå¯¹åº”ç­–ç•¥ï¼‰
  - è‹¥ Ray ä¸æ”¯æŒ `median`ï¼šä¸¤ç§é€‰æ‹©  
    1) **Engine-Specific**ï¼šå°† `median` æ ‡æ³¨ä¸º Spark-only  
    2) **Ray-Extended**ï¼šRay è‡ªç ” `median`ï¼ˆå¯ç”¨ç²¾ç¡®æˆ–è¿‘ä¼¼ä¸­ä½æ•°ï¼›è‹¥è¿‘ä¼¼å¿…é¡»æ ‡æ³¨ï¼‰
- **å¯¹é½ç­–ç•¥**ï¼š
  - `mean/most_frequent/constant`ï¼šä¼˜å…ˆ Intersection
  - `median`ï¼šEngine-Specific æˆ– Ray-Extendedï¼ˆäºŒé€‰ä¸€ï¼‰
- **å·®å¼‚ç‚¹**ï¼š
  - ç¼ºå¤±å€¼å®šä¹‰ï¼š`NaN / None` çš„å¤„ç†éœ€åœ¨å®ç°é‡Œç»Ÿä¸€
  - `most_frequent` tiesï¼ˆå¹¶åˆ—ä¼—æ•°ï¼‰é€‰æ‹©è§„åˆ™éœ€ä¸€è‡´ï¼ˆæˆ–å®šä¹‰ç¨³å®šè§„åˆ™ï¼‰

---

### 3.4 StringIndexer

- **åŠŸèƒ½**ï¼šå­—ç¬¦ä¸²ç±»åˆ« â†’ æ•°å­—ç´¢å¼•
- **ç±»å‹**ï¼šStatefulï¼ˆéœ€è¦å…¨å±€ç±»åˆ«é›†åˆä¸æ˜ å°„ï¼‰
- **è¾“å…¥**ï¼šç±»åˆ«å­—ç¬¦ä¸²åˆ—
- **è¾“å‡º**ï¼šæ•°å­—ç¼–ç åˆ—
- **å‚æ•°**ï¼š
  - `handle_invalid`ï¼š`'error' | 'skip' | 'keep'`
- **Spark å®ç°**ï¼š`StringIndexer`
- **Ray æ¨èå®ç°**ï¼š
  - **ä¸å»ºè®®**ï¼šç›´æ¥ç”¨ `sklearn.preprocessing.LabelEncoder`ï¼ˆä¸é€‚åˆç‰¹å¾åˆ—ä¸”éš¾å¯¹é½ Spark è¯­ä¹‰ï¼‰
  - ä¼˜å…ˆï¼šRay çš„ç±»åˆ«ç¼–ç  preprocessorï¼ˆè‹¥å¯ç”¨ï¼‰
  - æˆ–ï¼šè‡ªç ” `fit/transform`
    - `fit`ï¼šç»Ÿè®¡ç±»åˆ«é›†åˆå¹¶å»ºç«‹æ˜ å°„ï¼ˆåŒæ—¶è®°å½• unknown bucket è§„åˆ™ï¼‰
    - `transform`ï¼šæ˜ å°„åˆ°ç´¢å¼•ï¼›æŒ‰ `handle_invalid` å¤„ç†
- **å¯¹é½ç­–ç•¥**ï¼šæ¨è **Ray-Extended**ï¼ˆå› ä¸º `handle_invalid` ä¸ unseen è¡Œä¸ºå¿…é¡»ä¸¥æ ¼å®šä¹‰ï¼‰
- **å·®å¼‚ç‚¹ï¼ˆå¿…é¡»å†™æ¸…å¹¶æµ‹è¯•ï¼‰**ï¼š
  - `'error'`ï¼šé‡åˆ°æœªçŸ¥/æ— æ•ˆå€¼æŠ›é”™
  - `'skip'`ï¼šè¿‡æ»¤æ‰åŒ…å«æ— æ•ˆå€¼çš„è¡Œ
  - `'keep'`ï¼šå°†æœªçŸ¥å€¼æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šçš„ â€œunknown indexâ€ï¼ˆå¹¶ä¿è¯åç»­ OneHot ç»´åº¦ä¸€è‡´ï¼‰
  - ç±»åˆ«æ’åºè§„åˆ™ï¼šSpark å¸¸è§è§„åˆ™ä¸ Ray å¯èƒ½ä¸åŒï¼Œéœ€ç»Ÿä¸€ä¸ºï¼š
    - æ–¹æ¡ˆ 1ï¼šæŒ‰é¢‘ç‡é™åºï¼ˆæ¨èï¼Œè´´è¿‘ Spark å¸¸è§ç›´è§‰ï¼‰
    - æ–¹æ¡ˆ 2ï¼šæŒ‰å­—å…¸åºï¼ˆæ›´ç¨³å®šä½†å¯èƒ½ä¸ Spark ä¸åŒï¼‰
  > é€‰å“ªç§éƒ½å¯ä»¥ï¼Œä½†å¿…é¡»åœ¨æ–‡æ¡£ä¸­å›ºå®šï¼Œå¹¶åœ¨æµ‹è¯•ä¸­éªŒè¯ã€‚

---

### 3.5 OneHotEncoder

- **åŠŸèƒ½**ï¼šç‹¬çƒ­ç¼–ç 
- **ç±»å‹**ï¼šStatefulï¼ˆéœ€è¦å·²çŸ¥ç±»åˆ«é›†åˆ/ç»´åº¦ï¼›é€šå¸¸ä¾èµ– StringIndexerï¼‰
- **è¾“å…¥**ï¼šæ•°å­—ç¼–ç åˆ—ï¼ˆæˆ–åŸå§‹ç±»åˆ«åˆ—ï¼Œè‹¥ Ray ä¾§å®ç°åˆå¹¶ä¹Ÿéœ€è¯´æ˜ï¼‰
- **è¾“å‡º**ï¼šç‹¬çƒ­å‘é‡åˆ—ï¼ˆå›ºå®šé•¿åº¦ï¼‰
- **å‚æ•°**ï¼š
  - `drop_last`ï¼šæ˜¯å¦ä¸¢å¼ƒæœ€åä¸€ç»´é¿å…å¤šé‡å…±çº¿æ€§ï¼ˆé»˜è®¤ Trueï¼‰
  - `handle_invalid`ï¼šå»ºè®®å¤ç”¨ StringIndexer çš„ invalid ç­–ç•¥ï¼ˆè‹¥å®ç°åˆ†ç¦»ï¼‰
- **Spark å®ç°**ï¼š`OneHotEncoder`
- **Ray æ¨èå®ç°**ï¼š
  - ä¼˜å…ˆï¼šRay OneHot preprocessorï¼ˆè‹¥å¯ç”¨ï¼‰
  - `drop_last` è‹¥å†…ç½®ä¸æ”¯æŒï¼šåœ¨ transform ååšåå¤„ç†æˆªæ–­ï¼ˆ`vec[:-1]`ï¼‰
- **å¯¹é½ç­–ç•¥**ï¼š
  - **Intersection**ï¼šä»…å¯¹é½æ”¯æŒçš„å‚æ•°é›†åˆ
  - **Ray-Extended**ï¼šè¡¥é½ `drop_last`/unknown è¡Œä¸º
- **å·®å¼‚ç‚¹**ï¼š
  - unseen ç±»åˆ«ï¼šè‹¥ä½¿ç”¨ `'keep'`ï¼Œéœ€ä¿è¯ unknown æœ‰å›ºå®šç»´åº¦ä¸ä½ç½®ï¼ˆæˆ–å®šä¹‰ä¸ºå…¨ 0 å‘é‡ï¼Œä½†è¦ä¸ Spark å¯¹é½ï¼‰
  - è¾“å‡ºæ ¼å¼ï¼šå›ºå®šé•¿åº¦ç¨ å¯†å‘é‡ï¼ˆé»˜è®¤åŸºå‡†ç‰ˆï¼‰ï¼Œå¹¶æ˜ç¡® dtype

---

### 3.6 Tokenizer

- **åŠŸèƒ½**ï¼šæ–‡æœ¬åˆ†è¯
- **ç±»å‹**ï¼šStatelessï¼ˆé€šå¸¸ä¸éœ€è¦å…¨å±€ç»Ÿè®¡ï¼‰
- **è¾“å…¥**ï¼šæ–‡æœ¬å­—ç¬¦ä¸²åˆ—
- **è¾“å‡º**ï¼štoken æ•°ç»„åˆ—ï¼ˆ`list[str]`ï¼‰
- **å‚æ•°**ï¼š
  - `pattern`ï¼šåˆ†è¯æ¨¡å¼ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- **Spark å®ç°**ï¼š`Tokenizer`
- **Ray æ¨èå®ç°**ï¼š
  - `map_batches` + çº¯ Python/æ­£åˆ™ tokenizerï¼ˆæ¨èé»˜è®¤ï¼‰
  - å¦‚éœ€ NLTK/spaCyï¼šå¿…é¡»åœ¨å·¥ç¨‹è¯´æ˜ä¸­ä¿è¯ worker ä¾§ä¾èµ–å¯ç”¨ï¼ˆä¸å»ºè®®ä½œä¸ºé»˜è®¤ï¼‰
- **å¯¹é½ç­–ç•¥**ï¼š**Intersection**ï¼ˆä»¥æ­£åˆ™/è§„åˆ™ tokenizer å›ºå®šè¡Œä¸ºï¼‰
- **å·®å¼‚ç‚¹**ï¼š
  - å¤§å°å†™ã€æ ‡ç‚¹ã€ç©ºç™½è§„åˆ™å¿…é¡»å›ºå®š
  - ç©º token å¤„ç†è§„åˆ™å¿…é¡»å›ºå®š

---

### 3.7 HashingTF

- **åŠŸèƒ½**ï¼šç‰¹å¾å“ˆå¸Œå‘é‡åŒ–ï¼ˆtoken â†’ hash bucket è®¡æ•°å‘é‡ï¼‰
- **ç±»å‹**ï¼šStatelessï¼ˆä¸éœ€è¦è¯è¡¨ï¼‰
- **è¾“å…¥**ï¼štoken æ•°ç»„åˆ—
- **è¾“å‡º**ï¼šé•¿åº¦ä¸º `num_features` çš„å‘é‡åˆ—
- **å‚æ•°**ï¼š
  - `num_features`ï¼šç‰¹å¾ç»´åº¦ï¼ˆé»˜è®¤ `2^18`ï¼‰
- **Spark å®ç°**ï¼š`HashingTF`
- **Ray æ¨èå®ç°**ï¼š
  - `map_batches` + è‡ªç ” hashingï¼ˆæ¨èï¼Œä¾¿äºå›ºå®š hash ç§å­ä¸ç¢°æ’è¡Œä¸ºï¼‰
  - æˆ– `map_batches + sklearn.HashingVectorizer`ï¼ˆä½†éœ€é”å®š tokenizer/è¾“å‡ºæ ¼å¼ï¼‰
- **å¯¹é½ç­–ç•¥**ï¼š**Ray-Extended**ï¼ˆæ¨èè‡ªç ” hash ä»¥æ›´æ˜“å¯¹é½ Spark çš„å“ˆå¸Œç»†èŠ‚ï¼‰
- **å·®å¼‚ç‚¹**ï¼š
  - å“ˆå¸Œå‡½æ•°ä¸ç¬¦å·ï¼ˆsigned hashï¼‰è¡Œä¸ºè¦å›ºå®š
  - è¾“å‡ºç¨ å¯†/ç¨€ç–è¡¨ç¤ºè¦å›ºå®š
  - åŒ token åœ¨åŒæ–‡æ¡£çš„è®¡æ•°è§„åˆ™è¦å›ºå®š

---

### 3.8 IDFï¼ˆInverse Document Frequencyï¼‰

- **åŠŸèƒ½**ï¼šå°† TF å‘é‡è½¬æ¢ä¸º TF-IDF å‘é‡ï¼ˆéœ€è¦å…¨å±€ DF/IDFï¼‰
- **ç±»å‹**ï¼šStatefulï¼ˆå¿…é¡»å…¨å±€ fit ç»Ÿè®¡ DFï¼‰
- **è¾“å…¥**ï¼šTF å‘é‡åˆ—
- **è¾“å‡º**ï¼šTF-IDF å‘é‡åˆ—
- **å‚æ•°**ï¼š
  - `min_doc_freq`ï¼šæœ€å°æ–‡æ¡£é¢‘ç‡ï¼ˆé»˜è®¤ 1ï¼‰
- **Spark å®ç°**ï¼š`IDF`
- **Ray æ¨èå®ç°**ï¼š
  - **å¿…é¡»**ï¼šè‡ªç ” `fit/transform` æˆ– Ray preprocessorï¼ˆè‹¥å¯ç”¨ä¸”èƒ½å¯¹é½ï¼‰
    - `fit`ï¼šç»Ÿè®¡æ¯ä¸ªç»´åº¦ï¼ˆhash bucket æˆ– termï¼‰çš„ DFï¼Œè®¡ç®— IDF
    - `transform`ï¼šå¯¹ TF å‘é‡é€ç»´ç¼©æ”¾
- **å¯¹é½ç­–ç•¥**ï¼š**Ray-Extended**
- **å·®å¼‚ç‚¹**ï¼š
  - æ–‡æ¡£é¢‘ç‡å®šä¹‰ï¼ˆå‡ºç°å³ç®—ä¸€æ¬¡ vs è®¡æ•°ï¼‰å¿…é¡»å›ºå®š
  - `min_doc_freq` è¿‡æ»¤è§„åˆ™å¿…é¡»ä¸€è‡´
  - å‘é‡è¡¨ç¤ºï¼ˆç¨ å¯†/ç¨€ç–ï¼‰å¿…é¡»å›ºå®š

---

## 4. å®ç°çŠ¶æ€ï¼ˆå»ºè®®åœ¨é¡¹ç›®ä¸­æŒç»­æ›´æ–°ï¼‰

### å·²å®ç°ç®—å­
- âœ… StandardScalerï¼ˆSpark + Rayï¼‰  
  - è‹¥ Ray å½“å‰å®ç°ä¸º `map_batches + sklearn`ï¼Œéœ€ç¡®è®¤æ˜¯å¦ä¸º **å…¨å±€ fit å transform**ï¼Œå¦åˆ™éœ€é‡æ„ä¸º Stateful æµç¨‹ã€‚

### å¼€å‘ä¸­ç®—å­ï¼ˆå»ºè®®ä¼˜å…ˆï¼‰
- ğŸ”„ StringIndexerï¼ˆé«˜é£é™©å·®å¼‚ï¼šhandleInvalid/unseen/æ’åºè§„åˆ™ï¼‰
- ğŸ”„ OneHotEncoderï¼ˆä¾èµ– StringIndexerï¼Œdrop_last ä¸ unknown ç­–ç•¥éœ€å¯¹é½ï¼‰
- ğŸ”„ Imputerï¼ˆmedian ç­–ç•¥æ˜¯å¦æ”¯æŒéœ€å®šç­–ï¼‰

### å¾…å®ç°ç®—å­
- â³ MinMaxScaler
- â³ Tokenizer
- â³ HashingTF
- â³ IDF

---

## 5. ç®—å­è§„æ ¼å®šä¹‰ï¼ˆå»ºè®®æ‰©å±•å­—æ®µï¼‰

æ¯ä¸ªç®—å­éœ€å®šä¹‰ä»¥ä¸‹è§„æ ¼ï¼ˆå»ºè®®æ‰©å±•ä»¥æ”¯æŒå¯¹é½ä¸ fit/transformï¼‰ï¼š

```python
OperatorSpec(
    name="StandardScaler",
    category="NumericalPreprocessing",
    stateful=True,  # æ˜¯å¦éœ€è¦ fit
    input_cols=["feature1", "feature2"],
    output_cols=["feature1_scaled", "feature2_scaled"],
    params={
        "with_mean": True,
        "with_std": True
    },
    alignment_policy="Intersection",  # Intersection | Ray-Extended | Engine-Specific
    output_schema={
        "dtype": "float64",
        "format": "scalar"  # scalar | dense_vector | sparse_vector
    },
    ray_impl_hint={
        "preferred": "preprocessor_or_fit_transform",
        "batch_format": "pandas",
        "no_inplace_mutation": True
    },
    description="Standardize features by removing the mean and scaling to unit variance"
)
```